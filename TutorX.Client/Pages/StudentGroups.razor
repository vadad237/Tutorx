@page "/student-groups"
@using TutorX.Shared.DTOs
@using TutorX.Client.Services
@inject IStudentGroupService StudentGroupService
@inject IStudentService StudentService
@inject IJSRuntime JSRuntime

<PageTitle>Študentské skupiny</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h1>Študentské skupiny</h1>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" @onclick="ShowAddGroupModal">
                <i class="bi bi-plus-circle"></i> Prida? skupinu
            </button>
        </div>
    </div>

    @if (loading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Na?ítava sa...</span>
            </div>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }
    else if (successMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    @if (!loading)
    {
        <div class="row">
            @if (groups.Any())
            {
                @foreach (var group in groups)
                {
                    <div class="col-md-4 col-lg-3 mb-4">
                        <div class="card group-card @(expandedGroupId == group.Id ? "expanded" : "")" @onclick="() => ToggleGroup(group.Id)">
                            <div class="card-body">
                                <h5 class="card-title">@group.Name</h5>
                                <p class="card-text text-muted">
                                    <i class="bi bi-people-fill"></i> @group.Students.Count študent@(group.Students.Count != 1 ? "i" : "")
                                </p>
                                @if (!string.IsNullOrWhiteSpace(group.Description))
                                {
                                    <p class="card-description">@group.Description</p>
                                }
                                <div class="card-actions" @onclick:stopPropagation="true">
                                    <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => ShowEditGroupModal(group)">
                                        <i class="bi bi-pencil">Upravi?</i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteGroup(group.Id)">
                                        <i class="bi bi-trash">Vymaza?</i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12">
                    <div class="alert alert-info">
                        Nenašli sa žiadne skupiny. Kliknite na "Prida? skupinu" pre vytvorenie prvej skupiny.
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Group Details Modal -->
@if (expandedGroupId.HasValue)
{
    var group = groups.FirstOrDefault(g => g.Id == expandedGroupId.Value);
    if (group != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@group.Name - Študenti</h5>
                        <button type="button" class="btn-close" @onclick="CloseGroupDetails"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <button class="btn btn-sm btn-success" @onclick="() => ShowAddStudentToGroupModal(group.Id)">
                                <i class="bi bi-person-plus"></i> Prida? študenta
                            </button>
                        </div>
                        @if (group.Students.Any())
                        {
                            <div class="list-group">
                                @foreach (var student in group.Students)
                                {
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>@student.Name</strong>
                                            <br />
                                            <small class="text-muted">@student.Email</small>
                                        </div>
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveStudentFromGroup(group.Id, student.Id)">
                                            <i class="bi bi-x-circle"></i> Odstráni?
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">V tejto skupine zatia? nie sú žiadni študenti.</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
}

<!-- Add/Edit Group Modal -->
@if (showGroupModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isEditingGroup ? "Upravi? skupinu" : "Prida? skupinu")</h5>
                    <button type="button" class="btn-close" @onclick="CloseGroupModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Názov <span class="text-danger">*</span></label>
                        <input type="text" class="form-control @(string.IsNullOrWhiteSpace(groupName) && showValidation ? "is-invalid" : "")" @bind="groupName" />
                        @if (string.IsNullOrWhiteSpace(groupName) && showValidation)
                        {
                            <div class="invalid-feedback">Názov je povinný</div>
                        }
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Popis (volite?né)</label>
                        <textarea class="form-control" rows="3" @bind="groupDescription"></textarea>
                    </div>
                    @if (!isEditingGroup)
                    {
                        <div class="mb-3">
                            <label class="form-label">Priradi? študentov (volite?né)</label>
                            <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="selectAllGroupStudents"
                                           checked="@(selectedStudentIds.Count == availableStudents.Count && availableStudents.Any())"
                                           @onchange="ToggleSelectAllGroupStudents" />
                                    <label class="form-check-label fw-bold" for="selectAllGroupStudents">
                                        Vybra? všetkých
                                    </label>
                                </div>
                                <hr class="my-2" />
                                @foreach (var student in availableStudents)
                                {
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox"
                                               id="groupStudent_@student.Id"
                                               checked="@selectedStudentIds.Contains(student.Id)"
                                               @onchange="@((e) => ToggleGroupStudentSelection(student.Id, e))" />
                                        <label class="form-check-label" for="groupStudent_@student.Id">
                                            @student.Name
                                        </label>
                                    </div>
                                }
                                @if (!availableStudents.Any())
                                {
                                    <p class="text-muted mb-0">Žiadni dostupní študenti</p>
                                }
                            </div>
                            <div class="form-text mt-2">Vybratých študentov: @selectedStudentIds.Count</div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseGroupModal">Zruši?</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveGroup">
                        @(isEditingGroup ? "Aktualizova?" : "Vytvori?")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Add Student to Group Modal -->
@if (showAddStudentModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Prida? študentov do skupiny</h5>
                    <button type="button" class="btn-close" @onclick="CloseAddStudentModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Vyberte študentov</label>
                        <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="selectAllModalGroupStudents"
                                       checked="@(selectedStudentIdsForModal.Count == GetAvailableStudentsForGroup(currentGroupIdForAddingStudent).Count && GetAvailableStudentsForGroup(currentGroupIdForAddingStudent).Any())"
                                       @onchange="ToggleSelectAllModalGroupStudents" />
                                <label class="form-check-label fw-bold" for="selectAllModalGroupStudents">
                                    Vybra? všetkých
                                </label>
                            </div>
                            <hr class="my-2" />
                            @foreach (var student in GetAvailableStudentsForGroup(currentGroupIdForAddingStudent))
                            {
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           id="modalGroupStudent_@student.Id"
                                           checked="@selectedStudentIdsForModal.Contains(student.Id)"
                                           @onchange="@((e) => ToggleModalGroupStudentSelection(student.Id, e))" />
                                    <label class="form-check-label" for="modalGroupStudent_@student.Id">
                                        @student.Name (@student.Email)
                                    </label>
                                </div>
                            }
                            @if (!GetAvailableStudentsForGroup(currentGroupIdForAddingStudent).Any())
                            {
                                <p class="text-muted mb-0">Všetci študenti sú už priradení k tejto skupine</p>
                            }
                        </div>
                        <div class="form-text mt-2">Vybratých študentov: @selectedStudentIdsForModal.Count</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAddStudentModal">Zruši?</button>
                    <button type="button" class="btn btn-primary" @onclick="AddStudentsToGroup" disabled="@(selectedStudentIdsForModal.Count == 0)">
                        Prida? (@selectedStudentIdsForModal.Count)
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<StudentGroupDto> groups = new();
    private List<StudentDto> availableStudents = new();
    private bool loading = true;
    private string? errorMessage;
    private string? successMessage;
    private bool showGroupModal = false;
    private bool isEditingGroup = false;
    private int? editingGroupId;
    private int? expandedGroupId;
    private bool showAddStudentModal = false;
    private int currentGroupIdForAddingStudent;
    private int selectedStudentIdToAdd;
    private List<int> selectedStudentIdsForModal = new();

    // Form fields
    private string groupName = "";
    private string? groupDescription;
    private List<int> selectedStudentIds = new();
    private bool showValidation = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            loading = true;
            errorMessage = null;
            groups = await StudentGroupService.GetStudentGroupsAsync();
            availableStudents = await StudentService.GetStudentsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Chyba pri na?ítavaní dát: {ex.Message}";
        }
        finally
        {
            loading = false;
        }
    }

    private void ToggleGroup(int groupId)
    {
        if (expandedGroupId == groupId)
        {
            expandedGroupId = null;
        }
        else
        {
            expandedGroupId = groupId;
        }
    }

    private void CloseGroupDetails()
    {
        expandedGroupId = null;
    }

    private void ShowAddGroupModal()
    {
        isEditingGroup = false;
        editingGroupId = null;
        groupName = "";
        groupDescription = null;
        selectedStudentIds = new();
        showValidation = false;
        showGroupModal = true;
    }

    private void ShowEditGroupModal(StudentGroupDto group)
    {
        isEditingGroup = true;
        editingGroupId = group.Id;
        groupName = group.Name;
        groupDescription = group.Description;
        showValidation = false;
        showGroupModal = true;
    }

    private void CloseGroupModal()
    {
        showGroupModal = false;
    }

    private async Task SaveGroup()
    {
        showValidation = true;

        if (string.IsNullOrWhiteSpace(groupName))
        {
   return;
      }

        try
        {
            if (isEditingGroup && editingGroupId.HasValue)
 {
  var updateDto = new UpdateStudentGroupDto
{
        Name = groupName,
      Description = groupDescription
            };
         await StudentGroupService.UpdateStudentGroupAsync(editingGroupId.Value, updateDto);
         successMessage = "Skupina úspešne aktualizovaná!";
            }
         else
        {
       var createDto = new CreateStudentGroupDto
                {
     Name = groupName,
 Description = groupDescription
   };
                var createdGroup = await StudentGroupService.CreateStudentGroupAsync(createDto);

          // Add students to the group if any were selected
          foreach (var studentId in selectedStudentIds)
  {
         try
          {
          await StudentGroupService.AddStudentToGroupAsync(createdGroup.Id, studentId);
        }
     catch
               {
                 // Continue if adding a student fails
       }
       }

      successMessage = "Skupina úspešne vytvorená!";
  }

   CloseGroupModal();
    await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Chyba pri ukladaní skupiny: {ex.Message}";
      }
    }

    private async Task DeleteGroup(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Ste si istý, že chcete vymaza? túto skupinu?"))
        {
  try
            {
    await StudentGroupService.DeleteStudentGroupAsync(id);
      successMessage = "Skupina úspešne vymazaná!";
        await LoadData();
 }
       catch (Exception ex)
  {
  errorMessage = $"Chyba pri mazaní skupiny: {ex.Message}";
      }
     }
    }

    private void ShowAddStudentToGroupModal(int groupId)
    {
        currentGroupIdForAddingStudent = groupId;
        selectedStudentIdToAdd = 0;
        selectedStudentIdsForModal = new();
        showAddStudentModal = true;
    }

    private void CloseAddStudentModal()
    {
        showAddStudentModal = false;
  }

    private async Task AddStudentToGroup()
    {
   if (selectedStudentIdToAdd == 0)
    return;

        try
        {
            await StudentGroupService.AddStudentToGroupAsync(currentGroupIdForAddingStudent, selectedStudentIdToAdd);
         successMessage = "Študent úspešne pridaný do skupiny!";
    CloseAddStudentModal();
            await LoadData();
     }
        catch (Exception ex)
    {
            errorMessage = $"Chyba pri pridávaní študenta do skupiny: {ex.Message}";
        }
    }

    private async Task AddStudentsToGroup()
    {
        if (selectedStudentIdsForModal.Count == 0)
            return;

        try
        {
     // Add each selected student to the group
       foreach (var studentId in selectedStudentIdsForModal)
            {
                await StudentGroupService.AddStudentToGroupAsync(currentGroupIdForAddingStudent, studentId);
    }

            var count = selectedStudentIdsForModal.Count;
       successMessage = count == 1
           ? "Študent úspešne pridaný do skupiny!"
: $"{count} študentov úspešne pridaných do skupiny!";
  CloseAddStudentModal();
            await LoadData();
        }
 catch (Exception ex)
        {
       errorMessage = $"Chyba pri pridávaní študentov do skupiny: {ex.Message}";
        }
    }

    private async Task RemoveStudentFromGroup(int groupId, int studentId)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Ste si istý, že chcete odstráni? tohto študenta zo skupiny?"))
        {
   try
        {
        await StudentGroupService.RemoveStudentFromGroupAsync(groupId, studentId);
       successMessage = "Študent úspešne odstránený zo skupiny!";
        await LoadData();
      }
       catch (Exception ex)
     {
             errorMessage = $"Chyba pri odstra?ovaní študenta zo skupiny: {ex.Message}";
    }
        }
    }

    private List<StudentDto> GetAvailableStudentsForGroup(int groupId)
    {
 var group = groups.FirstOrDefault(g => g.Id == groupId);
     if (group == null)
            return availableStudents;

        var studentIdsInGroup = group.Students.Select(s => s.Id).ToHashSet();
     return availableStudents.Where(s => !studentIdsInGroup.Contains(s.Id)).ToList();
    }

    private void OnStudentSelectionChanged(ChangeEventArgs e)
    {
        if (e.Value is string[] selectedValues)
        {
      selectedStudentIds = selectedValues.Select(int.Parse).ToList();
        }
        else if (e.Value is string singleValue && !string.IsNullOrEmpty(singleValue))
        {
            selectedStudentIds = new List<int> { int.Parse(singleValue) };
        }
      else
        {
  selectedStudentIds = new List<int>();
   }
    }

    private void ToggleGroupStudentSelection(int studentId, ChangeEventArgs e)
    {
        if (e.Value is bool isChecked)
        {
 if (isChecked)
            {
    if (!selectedStudentIds.Contains(studentId))
     {
    selectedStudentIds.Add(studentId);
          }
            }
   else
   {
      selectedStudentIds.Remove(studentId);
    }
     }
    }

    private void ToggleSelectAllGroupStudents(ChangeEventArgs e)
    {
    if (e.Value is bool isChecked)
        {
            if (isChecked)
 {
     selectedStudentIds = availableStudents.Select(s => s.Id).ToList();
 }
   else
   {
            selectedStudentIds.Clear();
   }
        }
    }

    private void ToggleModalGroupStudentSelection(int studentId, ChangeEventArgs e)
    {
if (e.Value is bool isChecked)
        {
 if (isChecked)
 {
    if (!selectedStudentIdsForModal.Contains(studentId))
         {
          selectedStudentIdsForModal.Add(studentId);
                }
   }
            else
 {
              selectedStudentIdsForModal.Remove(studentId);
            }
        }
    }

    private void ToggleSelectAllModalGroupStudents(ChangeEventArgs e)
    {
        if (e.Value is bool isChecked)
      {
  if (isChecked)
     {
      var availableStudents = GetAvailableStudentsForGroup(currentGroupIdForAddingStudent);
      selectedStudentIdsForModal = availableStudents.Select(s => s.Id).ToList();
            }
 else
      {
      selectedStudentIdsForModal.Clear();
       }
 }
    }
}
