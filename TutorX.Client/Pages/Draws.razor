@page "/draws"
@using TutorX.Shared.DTOs
@using TutorX.Client.Services
@inject IDrawService DrawService
@inject IActivityService ActivityService
@inject IStudentService StudentService
@inject IJSRuntime JSRuntime

<PageTitle>Náhodný výber (Žrebovania)</PageTitle>

<div class="container-fluid">
  <div class="row mb-3">
 <div class="col">
   <h1>Náhodný výber (Žrebovania)</h1>
        </div>
   <div class="col-auto">
     <button class="btn btn-primary" @onclick="ShowAddDrawModal">
   <i class="bi bi-plus-circle"></i> Nové žrebovanie
     </button>
   </div>
    </div>

@if (loading)
  {
<div class="text-center">
       <div class="spinner-border" role="status">
         <span class="visually-hidden">Na?ítava sa...</span>
</div>
  </div>
    }
  else if (errorMessage != null)
    {
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
@errorMessage
   <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
     </div>
    }
    else if (successMessage != null)
    {
  <div class="alert alert-success alert-dismissible fade show" role="alert">
  @successMessage
  <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    @if (!loading)
    {
    <div class="row">
 @if (draws.Any())
  {
 @foreach (var draw in draws)
   {
    <div class="col-md-6 col-lg-4 mb-4">
 <div class="card draw-card" @onclick="() => ShowDrawDetails(draw.Id)">
  <div class="card-body">
        <h5 class="card-title">@draw.Name</h5>
     <div class="card-info">
       <p class="card-text text-muted mb-2">
   <i class="bi bi-calendar"></i>
 <span class="info-label">Dátum:</span>
      @draw.CreatedAt.ToString("dd. MM. yyyy HH:mm")
        </p>
  <p class="card-text text-muted mb-2">
   <i class="bi bi-clipboard-check"></i>
    <span class="info-label">Aktivita:</span>
    @(draw.ActivityName ?? "Nešpecifikované")
   </p>
     <p class="card-text text-muted mb-2">
     <i class="bi bi-people-fill"></i>
    <span class="info-label">Vybraní:</span>
 @draw.Results.Count @(draw.Results.Count == 1 ? "študent" : draw.Results.Count < 5 ? "študenti" : "študentov")
</p>
   </div>
    <div class="card-actions" @onclick:stopPropagation="true">
      <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteDraw(draw.Id)">
     <i class="bi bi-trash"></i> Vymaza?
   </button>
  </div>
   </div>
       </div>
     </div>
}
      }
   else
{
 <div class="col-12">
     <div class="alert alert-info">
 Nenašli sa žiadne žrebovania. Kliknite na "Nové žrebovanie" pre vytvorenie prvého náhodného výberu.
    </div>
</div>
         }
   </div>
    }
</div>

<!-- Draw Details Modal -->
@if (expandedDrawId.HasValue)
{
    var draw = draws.FirstOrDefault(d => d.Id == expandedDrawId.Value);
    if (draw != null)
  {
   <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
   <div class="modal-dialog modal-lg">
          <div class="modal-content">
    <div class="modal-header">
   <h5 class="modal-title">@draw.Name - Vybraní študenti</h5>
        <button type="button" class="btn-close" @onclick="CloseDrawDetails"></button>
  </div>
<div class="modal-body">
 <div class="mb-3">
   <p><strong>Aktivita:</strong> @(draw.ActivityName ?? "Nešpecifikované")</p>
       <p><strong>Dátum:</strong> @draw.CreatedAt.ToString("dd. MMMM yyyy HH:mm")</p>
   </div>
   @if (draw.Results.Any())
  {
      <h6>Náhodne vybraní študenti:</h6>
      <div class="list-group">
      @foreach (var result in draw.Results)
  {
      <div class="list-group-item">
<i class="bi bi-person-check"></i> <strong>@result.StudentName</strong>
           </div>
  }
       </div>
    }
else
 {
     <p class="text-muted">Neboli vybraní žiadni študenti.</p>
    }
  </div>
  </div>
      </div>
  </div>
 }
}

<!-- Add Draw Modal -->
@if (showDrawModal)
{
  <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
  <div class="modal-content">
 <div class="modal-header">
  <h5 class="modal-title">Vytvori? nové žrebovanie</h5>
     <button type="button" class="btn-close" @onclick="CloseDrawModal"></button>
</div>
<div class="modal-body">
      <div class="mb-3">
        <label class="form-label">Názov <span class="text-danger">*</span></label>
    <input type="text" class="form-control @(string.IsNullOrWhiteSpace(drawName) && showValidation ? "is-invalid" : "")" @bind="drawName" />
   @if (string.IsNullOrWhiteSpace(drawName) && showValidation)
       {
   <div class="invalid-feedback">Názov je povinný</div>
 }
   </div>
       <div class="mb-3">
        <label class="form-label">Aktivita <span class="text-danger">*</span></label>
      <select class="form-select @(!selectedActivityId.HasValue && showValidation ? "is-invalid" : "")" @bind="selectedActivityId" @bind:after="OnActivitySelected">
     <option value="">-- Vyberte aktivitu --</option>
    @foreach (var activity in availableActivities)
    {
      <option value="@activity.Id">@activity.Name</option>
    }
  </select>
       @if (!selectedActivityId.HasValue && showValidation)
  {
   <div class="invalid-feedback">Aktivita je povinná</div>
  }
   </div>
  @if (selectedActivityId.HasValue)
    {
      var availableForDraw = GetStudentsAvailableForDraw();
      var alreadyInActivity = GetStudentsAlreadyInActivity();
  
   <div class="mb-3">
   <label class="form-label">Študenti na výber <span class="text-danger">*</span></label>
      <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
     <div class="form-check mb-2">
 <input class="form-check-input" type="checkbox" id="selectAllDrawStudents" 
          checked="@(selectedStudentIds.Count == availableForDraw.Count && availableForDraw.Any())"
     @onchange="ToggleSelectAllDrawStudents" />
          <label class="form-check-label fw-bold" for="selectAllDrawStudents">
       Vybra? všetkých
            </label>
  </div>
       <hr class="my-2" />
    @foreach (var student in availableForDraw.OrderBy(s => s.Name))
    {
     <div class="form-check">
       <input class="form-check-input" type="checkbox" 
      id="drawStudent_@student.Id" 
         checked="@selectedStudentIds.Contains(student.Id)"
       @onchange="@((e) => ToggleDrawStudentSelection(student.Id, e))" />
       <label class="form-check-label" for="drawStudent_@student.Id">
       @student.Name
      </label>
  </div>
     }
 @if (!availableForDraw.Any())
      {
              <p class="text-muted mb-0">Žiadni dostupní študenti na žrebovanie</p>
     }
              </div>
 <div class="form-text mt-2">
    <strong>Zobrazujú sa iba študenti, ktorí NIE SÚ priradení k tejto aktivite.</strong><br/>
          Vybratých študentov: @selectedStudentIds.Count
  @if (alreadyInActivity.Any())
      {
           <br />
  <span class="text-info">
         @alreadyInActivity.Count @(alreadyInActivity.Count == 1 ? "študent je" : alreadyInActivity.Count < 5 ? "študenti sú" : "študentov je") už v tejto aktivite a @(alreadyInActivity.Count == 1 ? "je vylú?ený" : "sú vylú?ení") zo žrebovania.
   </span>
        }
         </div>
  @if (selectedStudentIds.Count == 0 && showValidation)
    {
       <div class="text-danger mt-1" style="font-size: 0.875rem;">Musí by? vybratý aspo? jeden študent</div>
    }
</div>
   <div class="mb-3">
<label class="form-label">Po?et študentov na náhodný výber <span class="text-danger">*</span></label>
      <input type="number" class="form-control" min="1" max="@selectedStudentIds.Count" @bind="numberToSelect" />
     <div class="form-text">Ko?ko študentov sa má náhodne vybra? zo zoznamu vyššie (maximum: @selectedStudentIds.Count)</div>
   </div>
      <div class="alert alert-info">
 <i class="bi bi-info-circle"></i> <strong>Poznámka:</strong> Vybraní študenti budú automaticky pridaní do aktivity.
   </div>
      }
 </div>
      <div class="modal-footer">
 <button type="button" class="btn btn-secondary" @onclick="CloseDrawModal">Zruši?</button>
          <button type="button" class="btn btn-primary" @onclick="CreateDraw">
   <i class="bi bi-shuffle"></i> Spusti? žrebovanie
    </button>
     </div>
         </div>
   </div>
    </div>
}

@code {
    private List<DrawDto> draws = new();
    private List<ActivityDto> availableActivities = new();
    private List<StudentDto> availableStudents = new();
    private bool loading = true;
    private string? errorMessage;
    private string? successMessage;
    private bool showDrawModal = false;
    private int? expandedDrawId;

  // Form fields
    private string drawName = "";
    private int? selectedActivityId;
 private List<int> selectedStudentIds = new();
    private int numberToSelect = 1;
    private bool showValidation = false;

  protected override async Task OnInitializedAsync()
  {
     await LoadData();
}

    private async Task LoadData()
    {
  try
  {
      loading = true;
  errorMessage = null;
    draws = await DrawService.GetDrawsAsync();
   availableActivities = await ActivityService.GetActivitiesAsync();
  availableStudents = await StudentService.GetStudentsAsync();
    }
 catch (Exception ex)
    {
   errorMessage = $"Chyba pri na?ítavaní dát: {ex.Message}";
  }
     finally
     {
        loading = false;
     }
    }

    private void ShowDrawDetails(int drawId)
    {
 expandedDrawId = drawId;
    }

    private void CloseDrawDetails()
    {
  expandedDrawId = null;
  }

    private void ShowAddDrawModal()
  {
   drawName = "";
selectedActivityId = null;
  selectedStudentIds = new();
      numberToSelect = 1;
  showValidation = false;
      showDrawModal = true;
    }

    private void CloseDrawModal()
    {
 showDrawModal = false;
    }

    private void OnActivitySelected()
  {
     selectedStudentIds = new();
 numberToSelect = 1;
    }

    private List<StudentDto> GetStudentsAlreadyInActivity()
    {
  if (!selectedActivityId.HasValue)
         return new List<StudentDto>();

        var activity = availableActivities.FirstOrDefault(a => a.Id == selectedActivityId.Value);
        if (activity == null)
 return new List<StudentDto>();

   var activityStudentIds = activity.StudentIds.ToHashSet();
 return availableStudents.Where(s => activityStudentIds.Contains(s.Id)).ToList();
    }

 private List<StudentDto> GetStudentsAvailableForDraw()
  {
        if (!selectedActivityId.HasValue)
            return new List<StudentDto>();

   var activity = availableActivities.FirstOrDefault(a => a.Id == selectedActivityId.Value);
    if (activity == null)
return availableStudents;

  var activityStudentIds = activity.StudentIds.ToHashSet();
        return availableStudents.Where(s => !activityStudentIds.Contains(s.Id)).ToList();
    }

private async Task CreateDraw()
    {
 showValidation = true;

     if (string.IsNullOrWhiteSpace(drawName) || !selectedActivityId.HasValue || selectedStudentIds.Count == 0)
        {
   return;
  }

 if (numberToSelect < 1 || numberToSelect > selectedStudentIds.Count)
  {
   errorMessage = $"Po?et študentov na výber musí by? medzi 1 a {selectedStudentIds.Count}";
  return;
        }

  try
  {
  var createDto = new CreateDrawDto
    {
   Name = drawName,
   ActivityId = selectedActivityId,
   StudentIds = selectedStudentIds,
           NumberToSelect = numberToSelect
   };

  var createdDraw = await DrawService.CreateDrawAsync(createDto);
        
     // Add the selected students to the activity
        if (createdDraw.Results.Any() && selectedActivityId.HasValue)
      {
      var selectedStudentIdsFromDraw = createdDraw.Results.Select(r => r.StudentId).ToList();
  await ActivityService.AddStudentsToActivityAsync(selectedActivityId.Value, selectedStudentIdsFromDraw);
 }

  successMessage = $"Žrebovanie dokon?ené! {createdDraw.Results.Count} {(createdDraw.Results.Count == 1 ? "študent bol náhodne vybraný" : createdDraw.Results.Count < 5 ? "študenti boli náhodne vybratí" : "študentov bolo náhodne vybratých")} a {(createdDraw.Results.Count == 1 ? "pridaný" : "pridaní")} do aktivity.";
  CloseDrawModal();
    await LoadData();
  }
  catch (Exception ex)
  {
    errorMessage = $"Chyba pri vytváraní žrebovania: {ex.Message}";
    }
    }

    private async Task DeleteDraw(int id)
    {
if (await JSRuntime.InvokeAsync<bool>("confirm", "Naozaj chcete vymaza? toto žrebovanie?"))
  {
      try
 {
  await DrawService.DeleteDrawAsync(id);
        successMessage = "Žrebovanie bolo úspešne vymazané!";
     await LoadData();
}
     catch (Exception ex)
  {
 errorMessage = $"Chyba pri mazaní žrebovania: {ex.Message}";
 }
        }
  }

    private void OnStudentSelectionChanged(ChangeEventArgs e)
  {
        if (e.Value is string[] selectedValues)
{
selectedStudentIds = selectedValues.Select(int.Parse).ToList();
      }
      else if (e.Value is string singleValue && !string.IsNullOrEmpty(singleValue))
     {
   selectedStudentIds = new List<int> { int.Parse(singleValue) };
  }
 else
 {
 selectedStudentIds = new List<int>();
  }

 // Update numberToSelect if it exceeds the new selection count
 if (numberToSelect > selectedStudentIds.Count)
        {
         numberToSelect = selectedStudentIds.Count > 0 ? selectedStudentIds.Count : 1;
    }
    }

 private void ToggleDrawStudentSelection(int studentId, ChangeEventArgs e)
    {
 if (e.Value is bool isChecked)
        {
   if (isChecked)
   {
   if (!selectedStudentIds.Contains(studentId))
     {
   selectedStudentIds.Add(studentId);
     }
  }
  else
{
 selectedStudentIds.Remove(studentId);
   }
   
   // Update numberToSelect if it exceeds the new selection count
   if (numberToSelect > selectedStudentIds.Count)
   {
     numberToSelect = selectedStudentIds.Count > 0 ? selectedStudentIds.Count : 1;
    }
  }
 }

    private void ToggleSelectAllDrawStudents(ChangeEventArgs e)
  {
   if (e.Value is bool isChecked)
  {
   if (isChecked)
   {
          var availableForDraw = GetStudentsAvailableForDraw();
    selectedStudentIds = availableForDraw.Select(s => s.Id).ToList();
      }
   else
    {
        selectedStudentIds.Clear();
     }
   
   // Update numberToSelect to match the new selection count
   if (selectedStudentIds.Count > 0)
 {
     numberToSelect = selectedStudentIds.Count;
}
  else
        {
      numberToSelect = 1;
  }
  }
    }
}
