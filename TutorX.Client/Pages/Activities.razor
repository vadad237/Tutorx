@page "/activities"
@using TutorX.Shared.DTOs
@using TutorX.Client.Services
@inject IActivityService ActivityService
@inject IStudentService StudentService
@inject IJSRuntime JSRuntime

<PageTitle>Activities</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
 <div class="col">
    <h1>Activities</h1>
        </div>
        <div class="col-auto">
       <button class="btn btn-primary" @onclick="ShowAddActivityModal">
      <i class="bi bi-plus-circle"></i> Add Activity
    </button>
     </div>
</div>

    @if (loading)
    {
        <div class="text-center">
    <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
  </div>
  </div>
    }
    else if (errorMessage != null)
    {
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
  @errorMessage
       <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }
    else if (successMessage != null)
    {
     <div class="alert alert-success alert-dismissible fade show" role="alert">
         @successMessage
  <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
</div>
    }

 @if (!loading)
{
        <div class="table-responsive">
  <table class="table table-striped table-hover">
 <thead>
      <tr>
   <th>ID</th>
      <th>Name</th>
            <th>Description</th>
      <th>Assigned Students</th>
  <th>Actions</th>
       </tr>
</thead>
      <tbody>
   @if (activities.Any())
            {
           @foreach (var activity in activities)
       {
    <tr @onclick="() => ShowActivityDetails(activity.Id)" style="cursor: pointer;">
    <td>@activity.Id</td>
        <td>@activity.Name</td>
  <td>@(activity.Description ?? "-")</td>
      <td>@(activity.StudentNames.Any() ? string.Join(", ", activity.StudentNames) : "No Students")</td>
    <td @onclick:stopPropagation="true">
      <button class="btn btn-sm btn-warning me-1" @onclick="() => ShowEditActivityModal(activity)">
    <i class="bi bi-pencil"></i> Edit
           </button>
  <button class="btn btn-sm btn-danger" @onclick="() => DeleteActivity(activity.Id)">
    <i class="bi bi-trash"></i> Delete
         </button>
       </td>
       </tr>
     }
     }
            else
      {
            <tr>
        <td colspan="5" class="text-center">No activities found</td>
           </tr>
            }
      </tbody>
     </table>
   </div>
    }
</div>

<!-- Activity Details Modal -->
@if (expandedActivityId.HasValue)
{
    var activity = activities.FirstOrDefault(a => a.Id == expandedActivityId.Value);
    if (activity != null)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
      <div class="modal-content">
     <div class="modal-header">
          <h5 class="modal-title">@activity.Name - Assigned Students</h5>
              <button type="button" class="btn-close" @onclick="CloseActivityDetails"></button>
      </div>
        <div class="modal-body">
    <div class="mb-3">
     <button class="btn btn-sm btn-success" @onclick="() => ShowAddStudentToActivityModal(activity.Id)">
          <i class="bi bi-person-plus"></i> Add Student
        </button>
          </div>
   @if (activity.StudentNames.Any())
     {
       <div class="list-group">
 @foreach (var studentName in activity.StudentNames.Select((name, index) => new { Name = name, Id = activity.StudentIds[index] }))
       {
   <div class="list-group-item d-flex justify-content-between align-items-center">
         <div>
      <strong>@studentName.Name</strong>
                 </div>
             <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveStudentFromActivity(activity.Id, studentName.Id)">
    <i class="bi bi-x-circle"></i> Remove
              </button>
      </div>
           }
                  </div>
         }
   else
           {
    <p class="text-muted">No students assigned to this activity yet.</p>
   }
      </div>
  </div>
    </div>
    </div>
    }
}

<!-- Add/Edit Activity Modal -->
@if (showActivityModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
   <div class="modal-dialog">
       <div class="modal-content">
     <div class="modal-header">
     <h5 class="modal-title">@(isEditingActivity ? "Edit Activity" : "Add Activity")</h5>
    <button type="button" class="btn-close" @onclick="CloseActivityModal"></button>
      </div>
      <div class="modal-body">
    <div class="mb-3">
       <label class="form-label">Name <span class="text-danger">*</span></label>
        <input type="text" class="form-control @(string.IsNullOrWhiteSpace(activityName) && showValidation ? "is-invalid" : "")" @bind="activityName" />
       @if (string.IsNullOrWhiteSpace(activityName) && showValidation)
           {
    <div class="invalid-feedback">Name is required</div>
             }
  </div>
        <div class="mb-3">
    <label class="form-label">Description (optional)</label>
      <textarea class="form-control" rows="3" @bind="activityDescription"></textarea>
      </div>
           @if (!isEditingActivity)
      {
          <div class="mb-3">
           <label class="form-label">Assign Students (optional)</label>
        <select multiple class="form-select" size="5" @onchange="OnStudentSelectionChanged">
          @foreach (var student in availableStudents)
   {
 <option value="@student.Id" selected="@selectedStudentIds.Contains(student.Id)">@student.Name</option>
   }
       </select>
     <div class="form-text">Hold Ctrl (Cmd on Mac) to select multiple students</div>
              </div>
         }
      </div>
                <div class="modal-footer">
         <button type="button" class="btn btn-secondary" @onclick="CloseActivityModal">Cancel</button>
         <button type="button" class="btn btn-primary" @onclick="SaveActivity">
     @(isEditingActivity ? "Update" : "Create")
   </button>
    </div>
     </div>
</div>
    </div>
}

<!-- Add Student to Activity Modal -->
@if (showAddStudentModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
   <div class="modal-dialog">
     <div class="modal-content">
 <div class="modal-header">
          <h5 class="modal-title">Add Student to Activity</h5>
   <button type="button" class="btn-close" @onclick="CloseAddStudentModal"></button>
    </div>
                <div class="modal-body">
    <div class="mb-3">
         <label class="form-label">Select Student</label>
           <select class="form-select" @bind="selectedStudentIdToAdd">
           <option value="">-- Select a student --</option>
               @foreach (var student in GetAvailableStudentsForActivity(currentActivityIdForAddingStudent))
             {
         <option value="@student.Id">@student.Name (@student.Email)</option>
  }
 </select>
          </div>
          </div>
        <div class="modal-footer">
         <button type="button" class="btn btn-secondary" @onclick="CloseAddStudentModal">Cancel</button>
  <button type="button" class="btn btn-primary" @onclick="AddStudentToActivity" disabled="@(selectedStudentIdToAdd == 0)">
         Add
    </button>
  </div>
            </div>
        </div>
    </div>
}

@code {
    private List<ActivityDto> activities = new();
    private List<StudentDto> availableStudents = new();
 private bool loading = true;
    private string? errorMessage;
    private string? successMessage;
  private bool showActivityModal = false;
    private bool isEditingActivity = false;
    private int? editingActivityId;
    private int? expandedActivityId;
  private bool showAddStudentModal = false;
    private int currentActivityIdForAddingStudent;
  private int selectedStudentIdToAdd;

 // Form fields
    private string activityName = "";
    private string? activityDescription;
    private List<int> selectedStudentIds = new();
    private bool showValidation = false;

    protected override async Task OnInitializedAsync()
    {
  await LoadData();
    }

    private async Task LoadData()
 {
        try
        {
     loading = true;
    errorMessage = null;
   activities = await ActivityService.GetActivitiesAsync();
  availableStudents = await StudentService.GetStudentsAsync();
  }
  catch (Exception ex)
        {
       errorMessage = $"Error loading data: {ex.Message}";
   }
        finally
      {
      loading = false;
  }
    }

    private void ShowActivityDetails(int activityId)
  {
      expandedActivityId = activityId;
    }

  private void CloseActivityDetails()
  {
        expandedActivityId = null;
    }

  private void ShowAddActivityModal()
    {
 isEditingActivity = false;
      editingActivityId = null;
activityName = "";
    activityDescription = null;
   selectedStudentIds = new();
  showValidation = false;
  showActivityModal = true;
    }

    private void ShowEditActivityModal(ActivityDto activity)
    {
        isEditingActivity = true;
    editingActivityId = activity.Id;
        activityName = activity.Name;
activityDescription = activity.Description;
     showValidation = false;
        showActivityModal = true;
    }

    private void CloseActivityModal()
    {
     showActivityModal = false;
    }

  private async Task SaveActivity()
    {
  showValidation = true;

      if (string.IsNullOrWhiteSpace(activityName))
        {
    return;
     }

        try
        {
        if (isEditingActivity && editingActivityId.HasValue)
         {
     var updateDto = new UpdateActivityDto
 {
           Name = activityName,
  Description = activityDescription,
          StudentIds = selectedStudentIds
        };
          await ActivityService.UpdateActivityAsync(editingActivityId.Value, updateDto);
  successMessage = "Activity updated successfully!";
  }
         else
      {
  var createDto = new CreateActivityDto
     {
   Name = activityName,
  Description = activityDescription,
  StudentIds = selectedStudentIds
           };
    var createdActivity = await ActivityService.CreateActivityAsync(createDto);
     successMessage = "Activity created successfully!";
     }

       CloseActivityModal();
await LoadData();
   }
        catch (Exception ex)
    {
       errorMessage = $"Error saving activity: {ex.Message}";
   }
}

  private async Task DeleteActivity(int id)
    {
  if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this activity?"))
  {
try
            {
   await ActivityService.DeleteActivityAsync(id);
           successMessage = "Activity deleted successfully!";
       await LoadData();
 }
         catch (Exception ex)
    {
  errorMessage = $"Error deleting activity: {ex.Message}";
      }
   }
    }

  private void ShowAddStudentToActivityModal(int activityId)
    {
        currentActivityIdForAddingStudent = activityId;
        selectedStudentIdToAdd = 0;
        showAddStudentModal = true;
    }

  private void CloseAddStudentModal()
    {
    showAddStudentModal = false;
    }

    private async Task AddStudentToActivity()
  {
        if (selectedStudentIdToAdd == 0)
          return;

  try
  {
        await ActivityService.AddStudentToActivityAsync(currentActivityIdForAddingStudent, selectedStudentIdToAdd);
  successMessage = "Student added to activity successfully!";
            CloseAddStudentModal();
      await LoadData();
        }
  catch (Exception ex)
        {
    errorMessage = $"Error adding student to activity: {ex.Message}";
   }
    }

    private async Task RemoveStudentFromActivity(int activityId, int studentId)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to remove this student from the activity?"))
  {
  try
  {
 await ActivityService.RemoveStudentFromActivityAsync(activityId, studentId);
              successMessage = "Student removed from activity successfully!";
             await LoadData();
     }
            catch (Exception ex)
      {
       errorMessage = $"Error removing student from activity: {ex.Message}";
            }
    }
    }

 private List<StudentDto> GetAvailableStudentsForActivity(int activityId)
    {
  var activity = activities.FirstOrDefault(a => a.Id == activityId);
        if (activity == null)
   return availableStudents;

        var studentIdsInActivity = activity.StudentIds.ToHashSet();
 return availableStudents.Where(s => !studentIdsInActivity.Contains(s.Id)).ToList();
}

  private void OnStudentSelectionChanged(ChangeEventArgs e)
  {
  if (e.Value is string[] selectedValues)
        {
     selectedStudentIds = selectedValues.Select(int.Parse).ToList();
}
   else if (e.Value is string singleValue && !string.IsNullOrEmpty(singleValue))
   {
      selectedStudentIds = new List<int> { int.Parse(singleValue) };
  }
        else
        {
 selectedStudentIds = new List<int>();
      }
    }
}
