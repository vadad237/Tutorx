@page "/activities"
@using TutorX.Shared.DTOs
@using TutorX.Client.Services
@inject IActivityService ActivityService
@inject IStudentService StudentService
@inject IJSRuntime JSRuntime

<PageTitle>Aktivity</PageTitle>

<div class="container-fluid">
    <div class="row mb-3">
 <div class="col">
    <h1>Aktivity</h1>
        </div>
    <div class="col-auto">
       <button class="btn btn-primary" @onclick="ShowAddActivityModal">
      <i class="bi bi-plus-circle"></i> Prida? aktivitu
</button>
     </div>
</div>

    @if (loading)
  {
        <div class="text-center">
    <div class="spinner-border" role="status">
          <span class="visually-hidden">Na?ítava sa...</span>
  </div>
  </div>
    }
    else if (errorMessage != null)
    {
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
  @errorMessage
     <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
      </div>
    }
    else if (successMessage != null)
    {
     <div class="alert alert-success alert-dismissible fade show" role="alert">
         @successMessage
  <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
</div>
    }

 @if (!loading)
{
  <div class="table-responsive">
  <table class="table table-striped table-hover">
 <thead>
      <tr>
   <th>ID</th>
      <th>Názov</th>
   <th>Popis</th>
      <th>Termín</th>
  <th>Priradení študenti</th>
       </tr>
</thead>
      <tbody>
   @if (activities.Any())
            {
     @foreach (var activity in activities)
{
    <tr @onclick="() => ShowActivityDetails(activity.Id)" style="cursor: pointer;">
    <td>@activity.Id</td>
        <td>@activity.Name</td>
  <td>@(activity.Description ?? "-")</td>
    <td>
        @if (activity.DueDate.HasValue)
    {
  <span class="@GetDueDateClass(activity.DueDate.Value)">
         @activity.DueDate.Value.ToString("dd. MM. yyyy")
 </span>
   }
      else
      {
           <span class="text-muted">Nespecifikované</span>
      }
 </td>
    <td>@(activity.StudentNames.Any() ? string.Join(", ", activity.StudentNames) : "Žiadni študenti")</td>
       </tr>
     }
     }
  else
      {
    <tr>
        <td colspan="5" class="text-center">Nenašli sa žiadne aktivity</td>
    </tr>
   }
  </tbody>
  </table>
   </div>
    }
</div>

<!-- Activity Details Modal -->
@if (expandedActivityId.HasValue)
{
    var activity = activities.FirstOrDefault(a => a.Id == expandedActivityId.Value);
    if (activity != null)
    {
 <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
          <div class="modal-dialog modal-lg">
    <div class="modal-content">
          <div class="modal-header">
   <h5 class="modal-title">@activity.Name</h5>
        <button type="button" class="btn-close" @onclick="CloseActivityDetails"></button>
    </div>
          <div class="modal-body">
            @if (activity.DueDate.HasValue)
       {
              <div class="alert alert-info mb-3">
   <i class="bi bi-calendar-event"></i> <strong>Termín:</strong> @activity.DueDate.Value.ToString("dd. MMMM yyyy")
  </div>
         }
 @if (!string.IsNullOrWhiteSpace(activity.Description))
     {
   <div class="mb-3">
        <p><strong>Popis:</strong></p>
             <p>@activity.Description</p>
             </div>
         }
         <hr />
       <div class="mb-3">
 <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Priradení študenti</h6>
  <button class="btn btn-sm btn-success" @onclick="() => ShowAddStudentToActivityModal(activity.Id)">
<i class="bi bi-person-plus"></i> Prida? študenta
         </button>
        </div>
      @if (activity.StudentNames.Any())
    {
        <div class="list-group">
         @foreach (var studentName in activity.StudentNames.Select((name, index) => new { Name = name, Id = activity.StudentIds[index] }))
     {
    <div class="list-group-item d-flex justify-content-between align-items-center">
      <div>
        <strong>@studentName.Name</strong>
       </div>
             <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveStudentFromActivity(activity.Id, studentName.Id)">
         <i class="bi bi-x-circle"></i> Odstráni?
     </button>
        </div>
        }
               </div>
  }
     else
      {
           <p class="text-muted">K tejto aktivite zatia? nie sú priradení žiadni študenti.</p>
  }
       </div>
           </div>
         <div class="modal-footer">
    <button class="btn btn-info me-auto" @onclick="() => ShowSetDateModal(activity)">
            <i class="bi bi-calendar-event"></i> Nastavi? termín
    </button>
       <button class="btn btn-warning me-1" @onclick="() => ShowEditActivityModal(activity)">
  <i class="bi bi-pencil"></i> Upravi?
             </button>
     <button class="btn btn-danger" @onclick="() => DeleteActivity(activity.Id)">
 <i class="bi bi-trash"></i> Vymaza?
        </button>
         </div>
   </div>
    </div>
        </div>
    }
}

<!-- Add/Edit Activity Modal -->
@if (showActivityModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
   <div class="modal-dialog">
   <div class="modal-content">
     <div class="modal-header">
 <h5 class="modal-title">@(isEditingActivity ? "Upravi? aktivitu" : "Prida? aktivitu")</h5>
 <button type="button" class="btn-close" @onclick="CloseActivityModal"></button>
</div>
      <div class="modal-body">
    <div class="mb-3">
       <label class="form-label">Názov <span class="text-danger">*</span></label>
        <input type="text" class="form-control @(string.IsNullOrWhiteSpace(activityName) && showValidation ? "is-invalid" : "")" @bind="activityName" />
       @if (string.IsNullOrWhiteSpace(activityName) && showValidation)
        {
    <div class="invalid-feedback">Názov je povinný</div>
    }
  </div>
        <div class="mb-3">
    <label class="form-label">Popis (volite?né)</label>
      <textarea class="form-control" rows="3" @bind="activityDescription"></textarea>
  </div>
  <div class="mb-3">
      <label class="form-label">Termín (volite?né)</label>
      <input type="date" class="form-control" @bind="activityDueDate" />
        </div>
  @if (!isEditingActivity)
      {
          <div class="mb-3">
        <label class="form-label">Priradi? študentov (volite?né)</label>
   <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
    <div class="form-check mb-2">
         <input class="form-check-input" type="checkbox" id="selectAllStudents" 
    checked="@(selectedStudentIds.Count == availableStudents.Count && availableStudents.Any())"
 @onchange="ToggleSelectAllStudents" />
         <label class="form-check-label fw-bold" for="selectAllStudents">
 Vybra? všetkých
         </label>
            </div>
      <hr class="my-2" />
  @foreach (var student in availableStudents)
             {
           <div class="form-check">
               <input class="form-check-input" type="checkbox" 
     id="student_@student.Id" 
       checked="@selectedStudentIds.Contains(student.Id)"
            @onchange="@((e) => ToggleStudentSelection(student.Id, e))" />
            <label class="form-check-label" for="student_@student.Id">
          @student.Name
        </label>
             </div>
          }
       @if (!availableStudents.Any())
  {
   <p class="text-muted mb-0">Žiadni dostupní študenti</p>
           }
              </div>
  <div class="form-text mt-2">Vybratých študentov: @selectedStudentIds.Count</div>
  </div>
}
      </div>
       <div class="modal-footer">
<button type="button" class="btn btn-secondary" @onclick="CloseActivityModal">Zruši?</button>
         <button type="button" class="btn btn-primary" @onclick="SaveActivity">
     @(isEditingActivity ? "Aktualizova?" : "Vytvori?")
   </button>
    </div>
     </div>
</div>
    </div>
}

<!-- Set Date Modal -->
@if (showSetDateModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
 <div class="modal-dialog">
      <div class="modal-content">
  <div class="modal-header">
   <h5 class="modal-title">Nastavi? termín</h5>
         <button type="button" class="btn-close" @onclick="CloseSetDateModal"></button>
   </div>
  <div class="modal-body">
    <div class="mb-3">
             <label class="form-label">Aktivita: <strong>@dateActivityName</strong></label>
        </div>
          <div class="mb-3">
          <label class="form-label">Termín</label>
    <input type="date" class="form-control" @bind="activityDueDate" />
  <div class="form-text">Nechajte prázdne pre odstránenie termínu</div>
     </div>
</div>
   <div class="modal-footer">
   <button type="button" class="btn btn-secondary" @onclick="CloseSetDateModal">Zruši?</button>
 <button type="button" class="btn btn-primary" @onclick="SaveDueDate">
Uloži? termín
         </button>
     </div>
   </div>
</div>
    </div>
}

<!-- Add Student to Activity Modal -->
@if (showAddStudentModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
   <div class="modal-dialog">
     <div class="modal-content">
 <div class="modal-header">
      <h5 class="modal-title">Prida? študentov do aktivity</h5>
   <button type="button" class="btn-close" @onclick="CloseAddStudentModal"></button>
    </div>
     <div class="modal-body">
 <div class="mb-3">
       <label class="form-label">Vyberte študentov</label>
            <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
     <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="selectAllModalStudents" 
       checked="@(selectedStudentIdsForModal.Count == GetAvailableStudentsForActivity(currentActivityIdForAddingStudent).Count && GetAvailableStudentsForActivity(currentActivityIdForAddingStudent).Any())"
  @onchange="ToggleSelectAllModalStudents" />
  <label class="form-check-label fw-bold" for="selectAllModalStudents">
          Vybra? všetkých
         </label>
                </div>
         <hr class="my-2" />
             @foreach (var student in GetAvailableStudentsForActivity(currentActivityIdForAddingStudent))
        {
      <div class="form-check">
                <input class="form-check-input" type="checkbox" 
             id="modalStudent_@student.Id" 
  checked="@selectedStudentIdsForModal.Contains(student.Id)"
      @onchange="@((e) => ToggleModalStudentSelection(student.Id, e))" />
  <label class="form-check-label" for="modalStudent_@student.Id">
        @student.Name (@student.Email)
    </label>
      </div>
  }
          @if (!GetAvailableStudentsForActivity(currentActivityIdForAddingStudent).Any())
                {
                 <p class="text-muted mb-0">Všetci študenti sú už priradení k tejto aktivite</p>
  }
         </div>
        <div class="form-text mt-2">Vybratých študentov: @selectedStudentIdsForModal.Count</div>
 </div>
      </div>
 <div class="modal-footer">
<button type="button" class="btn btn-secondary" @onclick="CloseAddStudentModal">Zruši?</button>
<button type="button" class="btn btn-primary" @onclick="AddStudentsToActivity" disabled="@(selectedStudentIdsForModal.Count == 0)">
 Prida? (@selectedStudentIdsForModal.Count)
    </button>
  </div>
       </div>
 </div>
    </div>
}

@code {
    private List<ActivityDto> activities = new();
    private List<StudentDto> availableStudents = new();
 private bool loading = true;
    private string? errorMessage;
    private string? successMessage;
  private bool showActivityModal = false;
  private bool isEditingActivity = false;
    private int? editingActivityId;
    private int? expandedActivityId;
  private bool showAddStudentModal = false;
    private int currentActivityIdForAddingStudent;
  private int selectedStudentIdToAdd;
    private List<int> selectedStudentIdsForModal = new();
  private bool showSetDateModal = false;
    private int? dateActivityId;
    private string? dateActivityName;

 // Form fields
    private string activityName = "";
    private string? activityDescription;
    private List<int> selectedStudentIds = new();
    private bool showValidation = false;
    private DateTime? activityDueDate;

    protected override async Task OnInitializedAsync()
    {
  await LoadData();
    }

    private async Task LoadData()
 {
      try
     {
     loading = true;
    errorMessage = null;
   activities = await ActivityService.GetActivitiesAsync();
  availableStudents = await StudentService.GetStudentsAsync();
  }
  catch (Exception ex)
   {
    errorMessage = $"Error loading data: {ex.Message}";
   }
   finally
      {
      loading = false;
  }
  }

    private void ShowActivityDetails(int activityId)
  {
expandedActivityId = activityId;
  }

  private void CloseActivityDetails()
{
  expandedActivityId = null;
    }

  private void ShowAddActivityModal()
    {
 isEditingActivity = false;
      editingActivityId = null;
activityName = "";
    activityDescription = null;
        activityDueDate = null;
 selectedStudentIds = new();
  showValidation = false;
  showActivityModal = true;
    }

    private void ShowEditActivityModal(ActivityDto activity)
    {
 isEditingActivity = true;
editingActivityId = activity.Id;
     activityName = activity.Name;
activityDescription = activity.Description;
 activityDueDate = activity.DueDate;
 showValidation = false;
        showActivityModal = true;
    }

    private void CloseActivityModal()
    {
   showActivityModal = false;
    }

    private void ShowSetDateModal(ActivityDto activity)
    {
     dateActivityId = activity.Id;
        dateActivityName = activity.Name;
 activityDueDate = activity.DueDate;
  showSetDateModal = true;
    }

    private void CloseSetDateModal()
    {
showSetDateModal = false;
    }

    private async Task SaveDueDate()
    {
 if (!dateActivityId.HasValue)
        return;

        try
        {
       var activity = activities.FirstOrDefault(a => a.Id == dateActivityId.Value);
  if (activity == null)
   return;

    var updateDto = new UpdateActivityDto
{
       Name = activity.Name,
       Description = activity.Description,
      StudentIds = activity.StudentIds,
 DueDate = activityDueDate
            };

    await ActivityService.UpdateActivityAsync(dateActivityId.Value, updateDto);
            successMessage = "Termín bol úspešne aktualizovaný!";
      CloseSetDateModal();
await LoadData();
  }
   catch (Exception ex)
     {
      errorMessage = $"Chyba pri aktualizácii termínu: {ex.Message}";
     }
  }

  private async Task SaveActivity()
    {
  showValidation = true;

      if (string.IsNullOrWhiteSpace(activityName))
     {
  return;
     }

     try
    {
   if (isEditingActivity && editingActivityId.HasValue)
    {
            // Get the current activity to preserve the existing student assignments
       var currentActivity = activities.FirstOrDefault(a => a.Id == editingActivityId.Value);
 
     var updateDto = new UpdateActivityDto
 {
       Name = activityName,
  Description = activityDescription,
  // Preserve existing student assignments during edit
            StudentIds = currentActivity?.StudentIds ?? new List<int>(),
DueDate = activityDueDate
        };
   await ActivityService.UpdateActivityAsync(editingActivityId.Value, updateDto);
  successMessage = "Aktivita úspešne aktualizovaná!";
  }
  else
   {
  var createDto = new CreateActivityDto
     {
   Name = activityName,
  Description = activityDescription,
    StudentIds = selectedStudentIds,
      DueDate = activityDueDate
     };
    var createdActivity = await ActivityService.CreateActivityAsync(createDto);
     successMessage = "Aktivita úspešne vytvorená!";
     }

    CloseActivityModal();
await LoadData();
   }
      catch (Exception ex)
  {
       errorMessage = $"Chyba pri ukladaní aktivity: {ex.Message}";
   }
}

  private async Task DeleteActivity(int id)
    {
  if (await JSRuntime.InvokeAsync<bool>("confirm", "Ste si istý, že chcete vymaza? túto aktivitu? Všetky priradené úlohy budú taktiež vymazané."))
  {
try
    {
   await ActivityService.DeleteActivityAsync(id);
    successMessage = "Aktivita úspešne vymazaná!";
    CloseActivityDetails();
    await LoadData();
 }
   catch (HttpRequestException ex)
    {
     errorMessage = $"Chyba pri mazaní aktivity: {ex.Message}";
      CloseActivityDetails();
 }
     catch (Exception ex)
        {
      errorMessage = $"Chyba pri mazaní aktivity: {ex.Message}";
      CloseActivityDetails();
     }
 }
    }

  private void ShowAddStudentToActivityModal(int activityId)
    {
        currentActivityIdForAddingStudent = activityId;
        selectedStudentIdToAdd = 0;
   selectedStudentIdsForModal = new();
  showAddStudentModal = true;
  }

  private void CloseAddStudentModal()
    {
    showAddStudentModal = false;
    }

    private async Task AddStudentToActivity()
  {
   if (selectedStudentIdToAdd == 0)
      return;

  try
  {
        await ActivityService.AddStudentToActivityAsync(currentActivityIdForAddingStudent, selectedStudentIdToAdd);
  successMessage = "Študent úspešne pridaný k aktivite!";
    CloseAddStudentModal();
      await LoadData();
     }
  catch (Exception ex)
      {
    errorMessage = $"Chyba pri pridávaní študenta k aktivite: {ex.Message}";
   }
    }

    private async Task AddStudentsToActivity()
    {
      if (selectedStudentIdsForModal.Count == 0)
   return;

        try
     {
            // Add each selected student to the activity
          foreach (var studentId in selectedStudentIdsForModal)
          {
            await ActivityService.AddStudentToActivityAsync(currentActivityIdForAddingStudent, studentId);
            }
            
     var count = selectedStudentIdsForModal.Count;
      successMessage = count == 1 
           ? "Študent úspešne pridaný k aktivite!" 
      : $"{count} študentov úspešne pridaných k aktivite!";
        CloseAddStudentModal();
            await LoadData();
        }
        catch (Exception ex)
  {
            errorMessage = $"Chyba pri pridávaní študentov k aktivite: {ex.Message}";
        }
    }

  private async Task RemoveStudentFromActivity(int activityId, int studentId)
    {
    if (await JSRuntime.InvokeAsync<bool>("confirm", "Ste si istý, že chcete odstráni? tohto študenta z aktivity?"))
  {
  try
  {
 await ActivityService.RemoveStudentFromActivityAsync(activityId, studentId);
 successMessage = "Študent úspešne odstránený z aktivity!";
         await LoadData();
     }
            catch (Exception ex)
  {
    errorMessage = $"Chyba pri odstra?ovaní študenta z aktivity: {ex.Message}";
}
    }
    }

 private List<StudentDto> GetAvailableStudentsForActivity(int activityId)
    {
  var activity = activities.FirstOrDefault(a => a.Id == activityId);
      if (activity == null)
   return availableStudents;

        var studentIdsInActivity = activity.StudentIds.ToHashSet();
 return availableStudents.Where(s => !studentIdsInActivity.Contains(s.Id)).ToList();
}

  private void OnStudentSelectionChanged(ChangeEventArgs e)
  {
  if (e.Value is string[] selectedValues)
    {
   selectedStudentIds = selectedValues.Select(int.Parse).ToList();
}
   else if (e.Value is string singleValue && !string.IsNullOrEmpty(singleValue))
   {
      selectedStudentIds = new List<int> { int.Parse(singleValue) };
  }
     else
        {
 selectedStudentIds = new List<int>();
      }
    }

 private void ToggleStudentSelection(int studentId, ChangeEventArgs e)
    {
 if (e.Value is bool isChecked)
        {
   if (isChecked)
{
     if (!selectedStudentIds.Contains(studentId))
  {
       selectedStudentIds.Add(studentId);
       }
   }
  else
     {
selectedStudentIds.Remove(studentId);
   }
   }
    }

    private void ToggleSelectAllStudents(ChangeEventArgs e)
    {
 if (e.Value is bool isChecked)
     {
  if (isChecked)
  {
   selectedStudentIds = availableStudents.Select(s => s.Id).ToList();
   }
   else
        {
  selectedStudentIds.Clear();
     }
        }
    }

    private void ToggleModalStudentSelection(int studentId, ChangeEventArgs e)
    {
        if (e.Value is bool isChecked)
        {
            if (isChecked)
            {
        if (!selectedStudentIdsForModal.Contains(studentId))
          {
   selectedStudentIdsForModal.Add(studentId);
            }
          }
     else
  {
                selectedStudentIdsForModal.Remove(studentId);
 }
        }
    }

    private void ToggleSelectAllModalStudents(ChangeEventArgs e)
    {
    if (e.Value is bool isChecked)
        {
 if (isChecked)
            {
                var availableStudents = GetAvailableStudentsForActivity(currentActivityIdForAddingStudent);
      selectedStudentIdsForModal = availableStudents.Select(s => s.Id).ToList();
          }
       else
            {
  selectedStudentIdsForModal.Clear();
     }
  }
    }

    private string GetDueDateClass(DateTime dueDate)
    {
    var today = DateTime.Today;
    var daysUntilDue = (dueDate.Date - today).Days;

      if (daysUntilDue < 0)
     return "text-danger fw-bold"; // Overdue
 else if (daysUntilDue == 0)
       return "text-warning fw-bold"; // Due today
        else if (daysUntilDue <= 3)
   return "text-warning"; // Due soon
   else
      return "text-success"; // Not urgent
 }
}
